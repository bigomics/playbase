name: Playbase unittest

on:
  pull_request:
  workflow_dispatch:

permissions:
  contents: write

env:
  GITHUB_PAT: ${{ secrets.GITHUB_TOKEN }}
  CI: true

jobs:
  unittest:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref || github.ref }}
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up R
        uses: r-lib/actions/setup-r@v2
        with:
          use-public-rspm: true

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libcurl4-openssl-dev libssl-dev libxml2-dev libfontconfig1-dev libharfbuzz-dev libfribidi-dev libfreetype6-dev libpng-dev libtiff5-dev libjpeg-dev libgit2-dev libglpk-dev libgmp-dev libhdf5-dev

      - name: Update DESCRIPTION imports
        run: |
          Rscript -e "install.packages('renv', repos='https://cloud.r-project.org')"
          Rscript -e "source('dev/write_description.R')"

      - name: Commit updated DESCRIPTION
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add DESCRIPTION
          git diff --staged --quiet || git commit -m "chore: update DESCRIPTION imports [skip ci]"
          git push

      - name: Install R dependencies
        uses: r-lib/actions/setup-r-dependencies@v2
        with:
          extra-packages: any::devtools, any::testthat, github::bigomics/playdata

      - name: Run tests
        run: |
          Rscript -e "devtools::test(quiet=TRUE)" > test_result.txt 2>&1 || true
          cat test_result.txt
          if grep -q -i "Failed tests" test_result.txt; then
            echo "::error::There are failed tests, please download artifacts for more details."
            exit 1
          fi

      - name: Upload test log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-error-log
          path: ./test_result.txt
          if-no-files-found: ignore

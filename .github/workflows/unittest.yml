name: Playbase unittest
on: 
  pull_request:
  workflow_dispatch:
permissions:
  contents: write
env:
  DOCKER_TAG: bigomics/omicsplayground:devel
jobs:
  unittest:
    # runs-on: ubuntu-latest
    runs-on: self-hosted
    steps:
      -
        name: Checkout
        uses: actions/checkout@v3
        with:
          ref: ${{ github.head_ref || github.ref }}
          token: ${{ secrets.GITHUB_TOKEN }}
      -
        name: Update DESCRIPTION imports
        run: |
          docker run --rm -v "$PWD":/playbase -w /playbase rocker/tidyverse:4.3 \
            Rscript -e "install.packages('renv', repos='https://cloud.r-project.org'); source('dev/write_description.R')"
      -
        name: Commit updated DESCRIPTION
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add DESCRIPTION
          git diff --staged --quiet || git commit -m "chore: update DESCRIPTION imports [skip ci]"
          git push
      -
        name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      # - 
      #   name: Setup upterm session
      #   uses: lhotari/action-upterm@v1
      #   with:
      #     ## limits ssh access and adds the ssh public key for the user which triggered the workflow
      #     limit-access-to-actor: true
      #     ## limits ssh access and adds the ssh public keys of the listed GitHub users
      #     limit-access-to-users: mauromiguelm
      #     wait-timeout-minutes: 120
      -
        name: Build OPG docker
        id: build-opg-docker
        run: |
          docker build --build-arg DOCKER_TAG=$DOCKER_TAG -t $DOCKER_TAG -f ./.github/workflows/unittest/Dockerfile .
      # - 
      #   name: Setup upterm session
      #   uses: lhotari/action-upterm@v1
      #   with:
      #     ## limits ssh access and adds the ssh public key for the user which triggered the workflow
      #     limit-access-to-actor: true
      #     ## limits ssh access and adds the ssh public keys of the listed GitHub users
      #     limit-access-to-users: mauromiguelm
      #     wait-timeout-minutes: 120

      -
        name: Unittest docker
        id: test-snapshot
        run: |
          CONTAINER_NAME="run_tests_${{ github.run_id }}"
          docker run --name "$CONTAINER_NAME" -e CI=true $DOCKER_TAG
          docker cp "$CONTAINER_NAME":/test_result.txt .
      
      - 
        name: Check workflow result
        id: check-workflow-result
        run: |
          if [[ "${{ steps.test-snapshot.outputs.workflow_result }}" == "false" ]]; then
            echo "Workflow failed."
            exit 1
          fi
      - 
        name: Upload error log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-error-log
          path: ./test_result.txt
          if-no-files-found: ignore
name: Snapshot test
on: 
  pull_request:
  workflow_dispatch:
env:
  DOCKER_TAG: bigomics/omicsplayground:latest
jobs:
  unittest:
    runs-on: ubuntu-latest
    steps:
      -
        name: Checkout
        uses: actions/checkout@v3
      -
        name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2
      -
        name: Unittest docker
        id: test-snapshot
        run: |
          docker build --build-arg GITHUB_SHA=${{ github.sha }} -t ${{ env.DOCKER_TAG }} -f ./.github/workflows/build-test-push/Dockerfile .
          docker run --name run_tests bigomics/omicsplayground:latest
          docker cp run_tests:/test_result.txt .
      - 
        name: Upload error log
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: test-error-log
          path: ./test_result.txt
          if-no-files-found: ignore
      - 
        name: Setup upterm session
        uses: lhotari/action-upterm@v1
        with:
          ## limits ssh access and adds the ssh public key for the user which triggered the workflow
          limit-access-to-actor: true
          ## limits ssh access and adds the ssh public keys of the listed GitHub users
          limit-access-to-users: mauromiguelm
          wait-timeout-minutes: 120
      # -
      #   name: Fail GHA if snapshot test failed
      #   if: always()
      #   run: |
      #     if [[ "${{ steps.test-snapshot.outputs.test_result }}" == "FALSE" ]]; then
      #       exit 1
      #     fi 
